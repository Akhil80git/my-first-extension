<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VS Code Folder Versioning</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9fb; }
    h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
    .container { max-width: 1000px; margin: auto; }
    .folder {
      background: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      margin-bottom: 25px;
      padding: 18px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.06);
    }
    .folder h2 {
      margin: 0 0 15px;
      color: #2c3e50;
      font-size: 1.5em;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 9px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }
    button:hover { background: #005a99; }
    pre {
      background: #f4f4f4;
      padding: 14px;
      margin: 12px 0;
      border-radius: 6px;
      overflow-x: auto;
      border-left: 6px solid #ccc;
      font-family: 'Courier New', monospace;
      transition: all 0.3s ease;
      min-height: 50px;
    }
    .save-all-badge {
      background: #ffeb3b;
      color: #333;
      font-size: 0.8em;
      padding: 3px 10px;
      border-radius: 5px;
      margin-left: 12px;
      font-weight: bold;
    }
    .version-header {
      display: flex;
      align-items: center;
      margin: 0 0 12px;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>VS Code Folder Versioning Dashboard</h1>
    <div id="dashboard"></div>
  </div>

  <script>
    // ============== COLOR PALETTE ==============
    const SAVE_ALL_COLORS = [
      '#ffebee', '#f8bbd0', '#e1f5fe', '#e8f5e8',
      '#fff3e0', '#f3e5f5', '#e0f2f1', '#fffde7'
    ];

    // ============== INDIAN TIME ==============
    function toIndianTime(utc) {
      return new Date(utc).toLocaleString('en-IN', {
        timeZone: 'Asia/Kolkata',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      });
    }

    // ============== GROUP BY TIMESTAMP (WITHIN 1 SEC) ==============
    function getTimestampKey(timestamp) {
      const date = new Date(timestamp);
      const seconds = Math.floor(date.getTime() / 1000);
      return seconds;
    }

    async function loadDashboard() {
      const res = await fetch('/fetchDashboard');
      const data = await res.json();
      const container = document.getElementById('dashboard');
      container.innerHTML = '';

      // Step 1: Collect all versions across all folders
      const allVersions = [];
      Object.keys(data).forEach(folderName => {
        data[folderName].versions.forEach(v => {
          allVersions.push({
            folder: folderName,
            version: v.version,
            timestamp: v.timestamp,
            files: v.files,
            secKey: getTimestampKey(v.timestamp)
          });
        });
      });

      // Step 2: Group by timestamp (within 1 sec)
      const timestampGroups = new Map();
      allVersions.forEach(v => {
        const key = v.secKey;
        if (!timestampGroups.has(key)) timestampGroups.set(key, []);
        timestampGroups.get(key).push(v);
      });

      // Step 3: Identify Save All groups (2+ folders in same second)
      const saveAllGroups = new Map(); // secKey â†’ { color, badgeId }
      let groupCounter = 0;
      timestampGroups.forEach((versions, secKey) => {
        const uniqueFolders = new Set(versions.map(v => v.folder));
        if (uniqueFolders.size >= 2) {
          groupCounter++;
          const color = SAVE_ALL_COLORS[(groupCounter - 1) % SAVE_ALL_COLORS.length];
          saveAllGroups.set(secKey, { color, badgeId: groupCounter });
        }
      });

      // Step 4: Render dashboard
      Object.keys(data).forEach(folderName => {
        const folderDiv = document.createElement('div');
        folderDiv.className = 'folder';
        folderDiv.innerHTML = `<h2>${folderName.toUpperCase()}</h2>`;

        data[folderName].versions.forEach(version => {
          const secKey = getTimestampKey(version.timestamp);
          const saveAllInfo = saveAllGroups.get(secKey);
          const isSaveAll = !!saveAllInfo;

          const versionDiv = document.createElement('div');
          versionDiv.style.cssText = 'border-top:1px solid #eee; margin-top:20px; padding-top:20px;';

          const timeStr = toIndianTime(version.timestamp);
          versionDiv.innerHTML = `
            <div class="version-header">
              <strong>Version ${version.version} - ${timeStr}</strong>
              ${isSaveAll ? `<span class="save-all-badge">SAVE ALL #${saveAllInfo.badgeId}</span>` : ''}
            </div>`;

          const btn = document.createElement('button');
          btn.textContent = 'Reload this version';
          btn.onclick = () => {
            versionDiv.querySelectorAll('pre').forEach(p => p.remove());

            Object.keys(version.files).forEach(filename => {
              const pre = document.createElement('pre');
              pre.textContent = `${filename}:\n${version.files[filename]}`;

              if (isSaveAll) {
                pre.style.background = saveAllInfo.color;
                pre.style.borderLeftColor = darken(saveAllInfo.color, 40);
              } else {
                pre.style.background = '#f4f4f4';
                pre.style.borderLeftColor = '#ccc';
              }

              versionDiv.appendChild(pre);
            });
          };

          versionDiv.appendChild(btn);
          folderDiv.appendChild(versionDiv);
        });

        container.appendChild(folderDiv);
      });
    }

    // ============== DARKEN COLOR ==============
    function darken(color, percent) {
      const num = parseInt(color.slice(1), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return "#" + (0x1000000 +
        (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
        (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
        (B < 255 ? (B < 1 ? 0 : B) : 255)
      ).toString(16).slice(1);
    }

    // ============== AUTO REFRESH (optional) ==============
    // setInterval(loadDashboard, 5000);

    loadDashboard();
  </script>
</body>
</html>
