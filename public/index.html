<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VS Code Folder Versioning</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9fb; }
    h1 { color: #2c3e50; text-align: center; }
    .container { max-width: 1000px; margin: auto; }
    .folder {
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-bottom: 20px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .folder h2 {
      margin: 0 0 15px;
      color: #2c3e50;
      font-size: 1.4em;
      border-bottom: 2px solid #eee;
      padding-bottom: 8px;
    }
    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }
    button:hover { background: #005a99; }
    pre {
      background: #f4f4f4;
      padding: 12px;
      margin: 10px 0;
      border-radius: 6px;
      overflow-x: auto;
      border-left: 5px solid #ccc;
      font-family: 'Courier New', monospace;
      transition: all 0.3s ease;
    }
    .save-all-badge {
      background: #ffeb3b;
      color: #333;
      font-size: 0.75em;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>VS Code Folder Versioning Dashboard</h1>
    <div id="dashboard"></div>
  </div>

  <script>
    // ============== COLOR PALETTE FOR EACH "SAVE ALL" GROUP ==============
    const SAVE_ALL_COLORS = [
      '#ffebee', // light red
      '#f8bbd0', // pink
      '#e1f5fe', // light blue
      '#e8f5e8', // light green
      '#fff3e0', // light orange
      '#f3e5f5', // light purple
      '#e0f2f1', // teal
      '#fffde7'  // yellow
    ];

    // ============== INDIAN TIME ==============
    function toIndianTime(utc) {
      return new Date(utc).toLocaleString('en-IN', {
        timeZone: 'Asia/Kolkata',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      });
    }

    // ============== GLOBAL SAVE ALL GROUP TRACKING ==============
    let globalSaveAllGroupId = 0;
    const saveAllGroupColorMap = new Map(); // groupId â†’ color

    async function loadDashboard() {
      const res = await fetch('/fetchDashboard');
      const data = await res.json();
      const container = document.getElementById('dashboard');
      container.innerHTML = '';

      // Reset group counter for fresh load
      globalSaveAllGroupId = 0;
      saveAllGroupColorMap.clear();

      Object.keys(data).forEach(folderName => {
        const folderDiv = document.createElement('div');
        folderDiv.className = 'folder';
        folderDiv.innerHTML = `<h2>${folderName.toUpperCase()}</h2>`;

        data[folderName].versions.forEach(version => {
          const { version: verNum, timestamp, files, isAllSave = false } = version;

          // === ASSIGN GROUP ID & COLOR FOR SAVE ALL ===
          let groupColor = null;
          let groupId = null;

          if (isAllSave) {
            // Use a global group ID across ALL folders
            if (!version.globalGroupId) {
              version.globalGroupId = ++globalSaveAllGroupId;
            }
            groupId = version.globalGroupId;

            if (!saveAllGroupColorMap.has(groupId)) {
              const colorIndex = (groupId - 1) % SAVE_ALL_COLORS.length;
              saveAllGroupColorMap.set(groupId, SAVE_ALL_COLORS[colorIndex]);
            }
            groupColor = saveAllGroupColorMap.get(groupId);
          }

          const versionDiv = document.createElement('div');
          versionDiv.style.cssText = 'border-top:1px solid #eee; margin-top:18px; padding-top:18px;';

          const timeStr = toIndianTime(timestamp);
          versionDiv.innerHTML = `
            <h3 style="margin:0 0 12px; color:#2c3e50; display:flex; align-items:center;">
              Version ${verNum} - ${timeStr}
              ${isAllSave ? `<span class="save-all-badge">SAVE ALL #${groupId}</span>` : ''}
            </h3>`;

          const btn = document.createElement('button');
          btn.textContent = 'Reload this version';
          btn.onclick = () => {
            versionDiv.querySelectorAll('pre').forEach(p => p.remove());

            Object.keys(files).forEach(filename => {
              const pre = document.createElement('pre');
              pre.textContent = `${filename}:\n${files[filename]}`;

              if (isAllSave && groupColor) {
                // Same color for ALL files in this Save All group
                pre.style.background = groupColor;
                pre.style.borderLeftColor = darken(groupColor, 40);
              } else {
                // Default for single folder save
                pre.style.background = '#f4f4f4';
                pre.style.borderLeftColor = '#ccc';
              }

              versionDiv.appendChild(pre);
            });
          };

          versionDiv.appendChild(btn);
          folderDiv.appendChild(versionDiv);
        });

        container.appendChild(folderDiv);
      });
    }

    // ============== DARKEN COLOR FOR BORDER ==============
    function darken(color, percent) {
      const num = parseInt(color.slice(1), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return "#" + (0x1000000 +
        (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
        (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
        (B < 255 ? (B < 1 ? 0 : B) : 255)
      ).toString(16).slice(1);
    }

    // ============== AUTO REFRESH (optional) ==============
    // setInterval(loadDashboard, 10000); // every 10 sec

    loadDashboard();
  </script>
</body>
</html>
