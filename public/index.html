<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VS Code Folder Versioning - Global 3s Grouping</title>
  <style>
    * { box-sizing: border-box; }
    body {font-family:Arial,sans-serif;margin:0;background:#f9f9fb;color:#222;overflow:hidden;}
    h1 {color:#2c3e50;text-align:center;margin:16px 0 8px;font-size:1.8em;}
    
    .header {
      position: fixed;top:0;left:0;right:0;background:#f9f9fb;z-index:1000;
      border-bottom:1px solid #ddd;padding:10px 20px;
    }
    .controls {text-align:center;margin-bottom:8px;}
    .notice {text-align:center;font-size:.9em;color:#666;margin:6px 0;}
    .group-bar {
      background:#fff;padding:10px;border:1px solid #eee;border-radius:8px;
      text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    .group-btn {
      margin:3px;padding:6px 12px;border-radius:6px;font-weight:bold;cursor:pointer;
      border:1px solid transparent;
    }
    .group-btn.active {background:#007acc;color:white;}
    .group-btn.all {background:#4caf50;color:white;}
    .group-btn.all.active {background:#388e3c;}

    .content {
      margin-top: 180px;padding:0 20px;height:calc(100vh - 180px);overflow-y:auto;
    }
    .container {max-width:1000px;margin:0 auto;}

    .folder{background:white;border:1px solid #ddd;border-radius:10px;margin-bottom:18px;padding:15px;box-shadow:0 2px 5px rgba(0,0,0,.05);}
    .folder h2{margin:0 0 12px;color:#2c3e50;font-size:1.25em;border-bottom:2px solid #eee;padding-bottom:8px;text-transform:uppercase;}
    .version{border-top:1px solid #eee;margin-top:14px;padding-top:14px;}
    button{background:#007acc;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:bold;transition:.15s;}
    button:hover{background:#005a99;}
    pre{background:#f4f4f4;padding:12px;margin:10px 0 0 0;border-radius:6px;overflow-x:auto;border-left:5px solid #ccc;font-family:'Courier New',monospace;}
    .save-all-badge {
      font-size:0.75em;padding:2px 8px;border-radius:4px;margin-left:10px;font-weight:bold;
      border-left:3px solid;
    }
    .version-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
  </style>
</head>
<body>

  <div class="header">
    <h1>VS Code Folder Versioning — Global 3s Grouping</h1>
    <div class="controls">
      <button id="reloadBtn">Load Dashboard</button>
      <button id="sampleBtn">Load Sample Data</button>
    </div>
    <div class="notice">Logic: सभी folders मिलाकर timestamps को cluster करते हैं — यदि timestamps का फरक ≤ 3 सेकण्ड हो तो same color group.</div>
    <div id="groupBar" class="group-bar"></div>
  </div>

  <div class="content">
    <div class="container">
      <div id="dashboard"></div>
    </div>
  </div>

<script>
  const SAVE_ALL_COLORS = ['#ffebee','#f8bbd0','#e1f5fe','#e8f5e8','#fff3e0','#f3e5f5','#e0f2f1','#fffde7'];

  function toIndianTimeStr(isoOrMs){
    const d = new Date(isoOrMs);
    return d.toLocaleString('en-IN',{
      timeZone:'Asia/Kolkata',
      year:'numeric',month:'2-digit',day:'2-digit',
      hour:'2-digit',minute:'2-digit',second:'2-digit',
      hour12:false
    });
  }

  function darken(hex,percent){
    const h = hex.replace('#','');
    const num = parseInt(h,16);
    let r = (num>>16)&0xff, g = (num>>8)&0xff, b = num&0xff;
    r = Math.max(0,Math.min(255,Math.round(r-2.55*percent)));
    g = Math.max(0,Math.min(255,Math.round(g-2.55*percent)));
    b = Math.max(0,Math.min(255,Math.round(b-2.55*percent)));
    return "#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
  }

  function isLightColor(hex) {
    const h = hex.replace('#', '');
    const r = parseInt(h.substr(0,2),16);
    const g = parseInt(h.substr(2,2),16);
    const b = parseInt(h.substr(4,2),16);
    const brightness = (r*299 + g*587 + b*114) / 1000;
    return brightness > 128;
  }

  async function fetchDashboardFromServer(){
    try{
      const res = await fetch('/fetchDashboard');
      if(!res.ok) throw new Error('Server error');
      return await res.json();
    }catch(e){
      console.warn('Server fetch failed:',e);
      return null;
    }
  }

  function getSampleData(){
    return {
      "frontend":{versions:[
        {version:1,timestamp:"2025-11-16T10:17:24.000Z",files:{"index.html":"<html>v1</html>"}},
        {version:2,timestamp:"2025-11-16T10:17:59.000Z",files:{"index.html":"<html>v2</html>"}},
        {version:3,timestamp:"2025-11-16T10:18:30.000Z",files:{"index.html":"<html>v3</html>"}},
        {version:4,timestamp:"2025-11-16T10:19:00.000Z",files:{"index.html":"<html>v4</html>"}},
        {version:5,timestamp:"2025-11-16T10:19:30.000Z",files:{"index.html":"<html>v5</html>"}},
        {version:6,timestamp:"2025-11-16T10:20:00.000Z",files:{"index.html":"<html>v6</html>"}}
      ]},
      "api":{versions:[
        {version:1,timestamp:"2025-11-16T10:17:24.000Z",files:{"server.js":"// v1"}},
        {version:2,timestamp:"2025-11-16T10:18:00.000Z",files:{"server.js":"// v2"}}
      ]},
      "kml":{versions:[
        {version:1,timestamp:"2025-11-16T10:17:25.000Z",files:{"map.kml":"<kml>v1</kml>"}},
        {version:2,timestamp:"2025-11-16T10:18:01.000Z",files:{"map.kml":"<kml>v2</kml>"}}
      ]}
    };
  }

  function clusterGloballyAllVersions(allFolderData){
    const flat=[];
    Object.keys(allFolderData).forEach(f=>{
      const vlist = allFolderData[f].versions||[];
      vlist.forEach(v=>{
        const t = typeof v.timestamp==='number'?v.timestamp:Date.parse(v.timestamp);
        flat.push({folder:f, versionObj:v, timestampMs:t});
      });
    });
    flat.sort((a,b)=>a.timestampMs-b.timestampMs);

    const clusters=[];
    let cur=null;
    flat.forEach(it=>{
      if(!cur){
        cur={id:clusters.length+1,startMs:it.timestampMs,items:[it]};
        clusters.push(cur);
      }else{
        if(it.timestampMs-cur.startMs<=3000){
          cur.items.push(it);
        }else{
          cur={id:clusters.length+1,startMs:it.timestampMs,items:[it]};
          clusters.push(cur);
        }
      }
    });

    clusters.forEach((c,i)=>{
      c.color = SAVE_ALL_COLORS[i%SAVE_ALL_COLORS.length];
      c.borderColor = darken(c.color,30);
    });

    clusters.forEach(c=>{
      c.items.forEach(it=>{
        it.versionObj._globalCluster = {id:c.id,color:c.color,borderColor:c.borderColor,startMs:c.startMs};
      });
    });

    return {flat,clusters};
  }

  let currentData = null;
  let currentClusters = null;
  let selectedGroup = 'all';

  function renderGroupBar(){
    const bar = document.getElementById('groupBar');
    bar.innerHTML='';

    const allBtn = document.createElement('button');
    allBtn.className='group-btn all';
    allBtn.textContent='All';
    allBtn.onclick=()=>{selectGroup('all');};
    bar.appendChild(allBtn);

    currentClusters.forEach(c=>{
      const btn = document.createElement('button');
      btn.className='group-btn';
      btn.textContent=`Group ${c.id}`;
      btn.style.background = c.color;
      btn.style.border = `1px solid ${c.borderColor}`;
      btn.style.color = isLightColor(c.color) ? '#000' : '#fff';
      btn.onclick=()=>{selectGroup(c.id);};
      bar.appendChild(btn);
    });

    updateActiveButton();
  }

  function updateActiveButton(){
    document.querySelectorAll('#groupBar .group-btn').forEach(b=>b.classList.remove('active'));
    const activeBtn = selectedGroup==='all'?
      document.querySelector('#groupBar .all'):
      Array.from(document.querySelectorAll('#groupBar .group-btn')).find(b=>b.textContent===`Group ${selectedGroup}`);
    if(activeBtn) activeBtn.classList.add('active');
  }

  function selectGroup(gid){
    selectedGroup = gid;
    renderDashboard(currentData);
    updateActiveButton();
  }

  function renderDashboard(data){
    const container = document.getElementById('dashboard');
    container.innerHTML='';

    const filtered = {};
    Object.keys(data).forEach(f=>{
      const vers = data[f].versions||[];
      const keep = vers.filter(v=>{
        if(selectedGroup==='all') return true;
        const cl = v._globalCluster;
        return cl && cl.id===selectedGroup;
      });
      if(keep.length) filtered[f] = {versions:keep};
    });

    Object.keys(filtered).forEach(folderName=>{
      const folderDiv = document.createElement('div');
      folderDiv.className='folder';
      folderDiv.innerHTML=`<h2>${folderName}</h2>`;

      filtered[folderName].versions.forEach(version=>{
        const versionDiv = document.createElement('div');
        versionDiv.className='version';

        const clusterInfo = version._globalCluster;
        const timeStr = toIndianTimeStr(Date.parse(version.timestamp));

        const badgeHtml = clusterInfo ? `
          <span class="save-all-badge" style="
            background:${clusterInfo.color};
            color:${isLightColor(clusterInfo.color)?'#000':'#fff'};
            border-left-color:${clusterInfo.borderColor};
          ">GROUP #${clusterInfo.id}</span>
        ` : '';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'version-header';
        headerDiv.style.background = (selectedGroup !== 'all' && clusterInfo) ? clusterInfo.color : '#fff';
        headerDiv.style.padding = '6px 10px';
        headerDiv.style.borderRadius = '6px';
        headerDiv.style.borderLeft = clusterInfo ? `4px solid ${clusterInfo.borderColor}` : '4px solid #ccc';
        headerDiv.style.marginBottom = '8px';
        headerDiv.innerHTML = `
          <strong>Version ${version.version}</strong> - ${timeStr}
          ${badgeHtml}
        `;

        versionDiv.appendChild(headerDiv);

        const btn = document.createElement('button');
        btn.textContent='Reload this version';
        btn.onclick=()=>{
          versionDiv.querySelectorAll('pre').forEach(p=>p.remove());
          Object.keys(version.files||{}).forEach(filename=>{
            const pre = document.createElement('pre');
            pre.textContent=`${filename}:\n${version.files[filename]}`;
            
            if(selectedGroup !== 'all' && clusterInfo){
              pre.style.background = clusterInfo.color;
              pre.style.borderLeftColor = clusterInfo.borderColor;
            } else {
              pre.style.background = '#f4f4f4';
              pre.style.borderLeftColor = '#ccc';
            }
            versionDiv.appendChild(pre);
          });
        };
        versionDiv.appendChild(btn);
        folderDiv.appendChild(versionDiv);
      });

      container.appendChild(folderDiv);
    });
  }

  async function loadDashboard(useSample=false){
    let data = null;
    if(!useSample) data = await fetchDashboardFromServer();
    if(!data) data = getSampleData();

    Object.keys(data).forEach(f=>{
      data[f].versions = (data[f].versions||[]).map(v=>Object.assign({},v));
    });

    const {clusters} = clusterGloballyAllVersions(data);
    currentData = data;
    currentClusters = clusters;
    selectedGroup = 'all';

    renderGroupBar();
    renderDashboard(data);
  }

  document.getElementById('reloadBtn').addEventListener('click',()=>loadDashboard(false));
  document.getElementById('sampleBtn').addEventListener('click',()=>loadDashboard(true));

  loadDashboard(false);
</script>
</body>
</html>
