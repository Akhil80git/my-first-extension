<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VS Code Folder Versioning</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #f8f9fc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --primary: #007acc;
      --shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* TOP HEADER - SUPER COMPACT */
    header {
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 8px 16px;
      box-shadow: var(--shadow);
      z-index: 100;
      flex-shrink: 0;
    }
    header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1e40af;
      margin: 0;
    }
    .controls {
      display: flex;
      gap: 8px;
      margin: 6px 0;
      flex-wrap: wrap;
    }
    .notice {
      font-size: 0.78rem;
      color: #64748b;
      text-align: center;
      margin: 4px 0;
    }
    .group-bar {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 6px;
    }
    .group-btn {
      padding: 5px 12px;
      border: none;
      border-radius: 16px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .group-btn.all { background: #10b981; color: white; }
    .group-btn.active {
      transform: scale(1.06);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    /* MAIN CONTENT */
    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 400px 1fr;
      overflow: hidden;
    }
    .left-panel {
      background: white;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 12px;
    }
    .right-panel {
      padding: 20px;
      background: #f1f5f9;
      overflow-y: auto;
      display: none; /* Pehle hidden rahega */
    }
    .right-panel.active {
      display: block;
    }

    .folder {
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .folder h2 {
      background: #f8fafc;
      padding: 10px 14px;
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .version-header {
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      font-weight: 500;
      background: #fdfdfe;
      border-left: 4px solid #ccc;
      cursor: pointer;
    }
    .version-header:hover { background: #f8fafc; }
    .badge {
      font-size: 0.68rem;
      padding: 3px 9px;
      border-radius: 10px;
      font-weight: bold;
      color: white;
    }

    .tree-container {
      padding: 0 14px 10px;
      display: none;
      background: #fafafa;
    }
    .tree-container.open { display: block; }

    .tree-label {
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.9rem;
      font-family: 'Consolas', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tree-label:hover { background: #f1f5f9; }
    .tree-label.folder { color: #1d4ed8; font-weight: 600; }

    pre {
      margin: 8px 0;
      padding: 12px;
      background: #1e1e1e;
      color: #dccdc7;
      border-radius: 8px;
      position: relative;
      font-size: 0.88rem;
      overflow-x: auto;
    }
    .copy-btn {
      position: absolute;
      top: 6px; right: 8px;
      background: #007acc;
      color: white;
      border: none;
      padding: 4px 9px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .run-btn {
      margin: 10px 14px;
      background: #16a34a;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }
    .run-btn:hover { background: #15803d; }

    #preview {
      width: 100%;
      height: calc(100vh - 180px);
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: white;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

<header>
  <h1>VS Code Folder Versioning</h1>
  <div class="controls">
    <button id="reloadBtn" class="group-btn">Load Dashboard</button>
    <button id="sampleBtn" class="group-btn">Sample Data</button>
  </div>
  <div class="notice">3 सेकंड के अंदर save → same group</div>
  <div id="groupBar" class="group-bar"></div>
</header>

<div class="main">
  <div class="left-panel" id="dashboard"></div>
  <div class="right-panel" id="rightPanel">
    <h2>Live Preview</h2>
    <button id="runAllBtn" class="run-btn">Run Selected Version</button>
    <iframe id="preview" sandbox="allow-scripts allow-modals"></iframe>
  </div>
</div>

<script>
  const COLORS = ['#fee2e2','#ecfccb','#dbeafe','#fef3c7','#f3e8ff','#d1fae5','#fffbeb','#fce7f3'];
  let currentData = null;
  let currentClusters = null;
  let selectedGroup = null;
  let lastRunFiles = null;

  function toIndianTime(t) {
    return new Date(t).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', hour12: false });
  }

  function darken(hex, p=40) {
    return hex.replace(/\w\w/g, c => Math.max(0, parseInt(c,16) - p).toString(16).padStart(2,'0'));
  }

  function clusterAll(data) {
    const list = [];
    Object.keys(data).forEach(f => data[f].versions.forEach(v => list.push({f, v, t: Date.parse(v.timestamp)})));
    list.sort((a,b) => a.t - b.t);
    const groups = [];
    let cur = null;
    list.forEach(x => {
      if (!cur || x.t - cur.t > 3000) {
        cur = {id: groups.length+1, t: x.t, items: []};
        groups.push(cur);
      }
      cur.items.push(x);
      x.v._cluster = {id: cur.id, color: COLORS[cur.id-1], border: darken(COLORS[cur.id-1])};
    });
    return groups;
  }

  function renderGroupBar() {
    const bar = document.getElementById('groupBar');
    bar.innerHTML = '';
    const allBtn = document.createElement('button');
    allBtn.className = 'group-btn all';
    allBtn.textContent = 'All';
    allBtn.onclick = () => selectGroup('all');
    bar.appendChild(allBtn);

    currentClusters.forEach(g => {
      const b = document.createElement('button');
      b.className = 'group-btn';
      b.textContent = `Group ${g.id}`;
      b.style.background = g.items[0].v._cluster.color;
      b.style.color = '#000';
      b.onclick = () => selectGroup(g.id);
      bar.appendChild(b);
    });
    updateActiveBtn();
  }

  function updateActiveBtn() {
    document.querySelectorAll('.group-btn').forEach(b => b.classList.remove('active'));
    if (selectedGroup === 'all') {
      document.querySelector('.group-btn.all')?.classList.add('active');
    } else {
      document.querySelector(`.group-btn:nth-child(${selectedGroup})`)?.classList.add('active');
    }
  }

  function selectGroup(gid) {
    selectedGroup = gid;
    renderDashboard(currentData);
    renderGroupBar();
    document.getElementById('rightPanel').classList.toggle('active', gid !== null);
  }

  function renderDashboard(data) {
    const container = document.getElementById('dashboard');
    container.innerHTML = '';

    const filtered = selectedGroup === 'all' ? data :
      Object.keys(data).reduce((acc, f) => {
        const vers = data[f].versions.filter(v => v._cluster?.id == selectedGroup);
        if (vers.length) acc[f] = {versions: vers};
        return acc;
      }, {});

    Object.keys(filtered).forEach(folder => {
      const folderDiv = document.createElement('div');
      folderDiv.className = 'folder';
      folderDiv.innerHTML = `<h2>${folder}</h2>`;

      filtered[folder].versions.forEach(v => {
        const cluster = v._cluster || {};
        const header = document.createElement('div');
        header.className = 'version-header';
        header.style.background = cluster.color || '#f9fafb';
        header.style.borderLeftColor = cluster.border || '#94a3b8';
        header.innerHTML = `
          <span>Version ${v.version} • ${toIndianTime(v.timestamp)}</span>
          ${cluster.id ? `<span class="badge" style="background:${cluster.border};">GROUP #${cluster.id}</span>` : ''}
        `;

        const tree = document.createElement('div');
        tree.className = 'tree-container';
        buildTree(tree, v.files);

        const runBtn = document.createElement('button');
        runBtn.className = 'run-btn';
        runBtn.textContent = 'Run This Version';
        runBtn.onclick = () => runCode(v.files);

        header.onclick = () => tree.classList.toggle('open');
        const versionDiv = document.createElement('div');
        versionDiv.append(header, tree, runBtn);
        folderDiv.appendChild(versionDiv);
      });
      container.appendChild(folderDiv);
    });
  }

  function buildTree(container, obj, path = '') {
    Object.keys(obj).sort((a,b) => (typeof obj[b]==='object') - (typeof obj[a]==='object') || a.localeCompare(b))
      .forEach(key => {
        const val = obj[key];
        const isDir = typeof val === 'object' && val !== null;
        const label = document.createElement('div');
        label.className = `tree-label ${isDir?'folder':''}`;
        label.innerHTML = `${isDir ? 'Folder' : 'File'} ${key}`;
        if (!isDir) {
          label.onclick = () => {
            const pre = label.nextElementSibling?.tagName === 'PRE' ? label.nextElementSibling : null;
            if (pre) { pre.remove(); return; }
            const code = document.createElement('pre');
            code.textContent = val;
            const copy = document.createElement('button');
            copy.textContent = 'Copy';
            copy.className = 'copy-btn';
            copy.onclick = e => { e.stopPropagation(); navigator.clipboard.writeText(val); copy.textContent='Copied!'; setTimeout(()=>copy.textContent='Copy',1500); };
            code.appendChild(copy);
            label.after(code);
          };
        } else {
          const sub = document.createElement('div');
          sub.style.marginLeft = '20px';
          buildTree(sub, val, path + key + '/');
          label.onclick = () => sub.classList.toggle('open');
          container.appendChild(label);
          container.appendChild(sub);
        }
        container.appendChild(label);
      });
  }

  function runCode(files) {
    lastRunFiles = files;
    let html = '', css = '', js = '';
    function walk(o) {
      Object.keys(o).forEach(k => {
        if (typeof o[k] === 'object') walk(o[k]);
        else if (k.endsWith('.html')) html += o[k];
        else if (k.endsWith('.css')) css += `<style>${o[k]}</style>`;
        else if (k.endsWith('.js')) js += `<script>${o[k]}<\/script>`;
      });
    }
    walk(files);
    const src = `${html || '<h3 style="color:#666;text-align:center;margin-top:100px">No HTML found</h3>'}${css}${js}`;
    document.getElementById('preview').srcdoc = src;
  }

  document.getElementById('runAllBtn').onclick = () => lastRunFiles && runCode(lastRunFiles);

  async function load(sample = false) {
    let data = sample ? getSampleData() : await (await fetch('/fetchDashboard').catch(()=>null))?.json();
    if (!data) data = getSampleData();
    currentClusters = clusterAll(data);
    currentData = data;
    selectedGroup = null;
    document.getElementById('rightPanel').classList.remove('active');
    renderGroupBar();
    renderDashboard(data);
  }

  function getSampleData() {
    return {
      "Project A": { versions: [{ version:1, timestamp:"2025-11-17T10:00:00Z", files: { "index.html": "<h1>Hello</h1>", "style.css": "h1{color:red}", "app.js": "console.log('Hi')" } }] },
      "Project B": { versions: [{ version:1, timestamp:"2025-11-17T10:00:02Z", files: { "index.html": "<h1>Hi from B</h1>" } }] }
    };
  }

  document.getElementById('reloadBtn').onclick = () => load(false);
  document.getElementById('sampleBtn').onclick = () => load(true);

  load(true); // Auto load sample
</script>
</body>
</html>
