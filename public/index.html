<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VS Code Folder Versioning</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { color: #333; }
    .container { max-width: 900px; margin: auto; }
    .folder { margin-bottom: 30px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; }
    button { margin: 5px 0; padding: 6px 12px; cursor: pointer; background: #007acc; color: white; border: none; border-radius: 4px; }
    button:hover { background: #005a99; }
    pre {
      background: #f4f4f4;
      padding: 12px;
      margin: 8px 0;
      border-radius: 4px;
      overflow-x: auto;
      border-left: 5px solid #ccc;
      transition: all 0.3s ease;
    }
    .save-all-group { }
  </style>
</head>
<body>
  <div class="container">
    <h1>VS Code Folder Versioning Dashboard</h1>
    <div id="dashboard"></div>
  </div>

  <script>
    // ============== COLOR PALETTE FOR EACH "SAVE ALL" ==============
    const SAVE_ALL_COLORS = [
      '#d4edda', // green
      '#fff3cd', // yellow
      '#d1ecf1', // cyan
      '#f8d7da', // red
      '#e2d4f1', // purple
      '#d6d8db', // gray
      '#cce5ff', // blue
      '#f1d4f1'  // pink
    ];

    // ============== INDIAN TIME ==============
    function toIndianTime(utc) {
      return new Date(utc).toLocaleString('en-IN', {
        timeZone: 'Asia/Kolkata',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      });
    }

    // ============== TRACK SAVE ALL GROUPS ==============
    let saveAllGroupId = 0;
    const saveAllGroupColors = new Map(); // groupId â†’ color

    async function loadDashboard() {
      const res = await fetch('/fetchDashboard');
      const data = await res.json();
      const container = document.getElementById('dashboard');
      container.innerHTML = '';

      Object.keys(data).forEach(folderName => {
        const folderDiv = document.createElement('div');
        folderDiv.className = 'folder';
        folderDiv.innerHTML = `<h2 style="margin:0 0 15px; color:#2c3e50;">${folderName.toUpperCase()}</h2>`;

        data[folderName].versions.forEach(version => {
          const { version: verNum, timestamp, files, isAllSave = false } = version;

          // Assign a group color if it's a Save All
          let groupColor = null;
          if (isAllSave) {
            if (!version.groupId) {
              version.groupId = ++saveAllGroupId;
            }
            if (!saveAllGroupColors.has(version.groupId)) {
              const colorIndex = (saveAllGroupId - 1) % SAVE_ALL_COLORS.length;
              saveAllGroupColors.set(version.groupId, SAVE_ALL_COLORS[colorIndex]);
            }
            groupColor = saveAllGroupColors.get(version.groupId);
          }

          const versionDiv = document.createElement('div');
          versionDiv.style.cssText = 'border-top:1px solid #ddd; margin-top:15px; padding-top:15px;';

          const timeStr = toIndianTime(timestamp);
          versionDiv.innerHTML = `
            <h3 style="margin:0 0 10px; color:#2c3e50;">
              Version ${verNum} - ${timeStr}
              ${isAllSave ? '<span style="background:#ffeb3b; padding:2px 6px; border-radius:3px; font-size:0.8em; margin-left:8px;">SAVE ALL</span>' : ''}
            </h3>`;

          const btn = document.createElement('button');
          btn.textContent = 'Reload this version';
          btn.onclick = () => {
            // Clear old files
            versionDiv.querySelectorAll('pre').forEach(p => p.remove());

            Object.keys(files).forEach(filename => {
              const pre = document.createElement('pre');
              pre.textContent = `${filename}:\n${files[filename]}`;

              // APPLY COLOR ONLY IF SAVE ALL
              if (isAllSave && groupColor) {
                pre.style.background = groupColor;
                pre.style.borderLeftColor = darkenColor(groupColor, 30);
                pre.classList.add('save-all-group');
              } else {
                pre.style.background = '#f4f4f4';
                pre.style.borderLeftColor = '#ccc';
              }

              versionDiv.appendChild(pre);
            });
          };

          versionDiv.appendChild(btn);
          folderDiv.appendChild(versionDiv);
        });

        container.appendChild(folderDiv);
      });
    }

    // ============== DARKEN COLOR FOR BORDER ==============
    function darkenColor(color, percent) {
      const num = parseInt(color.slice(1), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
             (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
             (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    // ============== LOAD ==============
    loadDashboard();
  </script>
</body>
</html>
