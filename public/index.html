<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VS Code Folder Versioning - Global 3s Grouping</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #f8f9fc;
      --card: #ffffff;
      --border: #e0e0e0;
      --text: #1a1a1a;
      --primary: #007acc;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    header {
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      box-shadow: var(--shadow);
      z-index: 10;
    }
    header h1 {
      font-size: 1.4rem;
      color: #2c3e50;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .notice {
      font-size: 0.85rem;
      color: #666;
      text-align: center;
    }
    .group-bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
    }
    .group-btn {
      padding: 6px 14px;
      border: none;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .group-btn.all { background: #4caf50; color: white; }
    .group-btn.active { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

    /* Main Layout */
    .main {
      display: grid;
      grid-template-columns: 420px 1fr;
      overflow: hidden;
    }
    .left-panel {
      background: white;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px;
    }
    .right-panel {
      padding: 20px;
      overflow-y: auto;
      background: #f5f5f5;
    }
    .folder {
      margin-bottom: 24px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .folder h2 {
      background: #f0f2f5;
      padding: 12px 16px;
      margin: 0;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #444;
    }
    .version {
      border-top: 1px solid var(--border);
    }
    .version-header {
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: 0.2s;
    }
    .version-header:hover { background: #f8f9fa; }
    .badge {
      font-size: 0.7rem;
      padding: 3px 10px;
      border-radius: 12px;
      font-weight: bold;
    }
    .tree-container {
      padding: 0 16px 12px;
      display: none;
    }
    .tree-container.open { display: block; }
    .tree-label {
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 6px;
      font-family: 'Consolas', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tree-label:hover { background: #f0f0f0; }
    .tree-label.folder { color: #1976d2; font-weight: bold; }
    pre {
      margin: 8px 0;
      padding: 12px;
      background: #2d2d2d;
      color: #f8f8f2;
      border-radius: 8px;
      position: relative;
      overflow-x: auto;
    }
    .copy-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: #007acc;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    /* Right Panel Preview */
    #preview {
      width: 100%;
      height: 90vh;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: white;
    }
    .run-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .run-btn:hover { background: #218838; }
  </style>
</head>
<body>

<header>
  <h1><i class="fas fa-code-branch"></i> VS Code Folder Versioning — Global 3s Grouping</h1>
  <div class="controls">
    <button id="reloadBtn" class="group-btn"><i class="fas fa-sync"></i> Load Dashboard</button>
    <button id="sampleBtn" class="group-btn"><i class="fas fa-play"></i> Load Sample Data</button>
  </div>
  <div class="notice">Logic: सभी folders के timestamps को मिलाकर cluster → 3 सेकंड के अंदर = same group</div>
  <div id="groupBar" class="group-bar"></div>
</header>

<div class="main">
  <div class="left-panel" id="dashboard"></div>
  <div class="right-panel">
    <h2><i class="fas fa-tv"></i> Live Preview</h2>
    <button id="runAllBtn" class="run-btn" style="margin:10px 0;">Run All Files in this Version</button>
    <iframe id="preview" sandbox="allow-scripts"></iframe>
  </div>
</div>

<script>
  const SAVE_ALL_COLORS = ['#ffebee','#e8f5e8','#e3f2fd','#fff3e0','#f3e5f5','#e0f2f1','#fff8e1','#fce4ec'];
  let currentData = null;
  let currentClusters = null;
  let selectedGroup = 'all';
  let currentVersionFiles = {}; // for running

  function toIndianTimeStr(iso) {
    return new Date(iso).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', hour12: false });
  }

  function darken(hex, p=30) {
    let [r,g,b] = hex.match(/\w\w/g).map(x => parseInt(x,16));
    r = Math.max(0, r - p); g = Math.max(0, g - p); b = Math.max(0, b - p);
    return `#${[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('')}`;
  }

  function renderFileTree(container, filesObj, clusterInfo, versionKey) {
    currentVersionFiles[versionKey] = filesObj;

    function buildNode(obj, path = '') {
      const div = document.createElement('div');
      Object.keys(obj).sort((a,b) => {
        const aDir = typeof obj[a] === 'object';
        const bDir = typeof obj[b] === 'object';
        return bDir - aDir || a.localeCompare(b);
      }).forEach(key => {
        const val = obj[key];
        const fullPath = path ? `${path}/${key}` : key;
        const isDir = typeof val === 'object' && val !== null;
        const label = document.createElement('div');
        label.className = `tree-label ${isDir ? 'folder' : 'file'}`;
        label.innerHTML = `<i class="${isDir?'fas fa-folder':'fas fa-file-code'}"></i> ${key}`;
        
        if (!isDir) {
          label.onclick = () => {
            const existing = label.nextElementSibling;
            if (existing && existing.tagName === 'PRE') {
              existing.remove();
              return;
            }
            if (existing) existing.remove();
            const pre = document.createElement('pre');
            pre.textContent = val;
            const copy = document.createElement('button');
            copy.textContent = 'Copy';
            copy.className = 'copy-btn';
            copy.onclick = (e) => {
              e.stopPropagation();
              navigator.clipboard.writeText(val);
              copy.textContent = 'Copied!';
              setTimeout(() => copy.textContent = 'Copy', 1500);
            };
            pre.appendChild(copy);
            label.after(pre);
          };
        } else {
          const children = document.createElement('div');
          children.style.marginLeft = '20px';
          buildNode(val, fullPath);
          label.onclick = () => children.classList.toggle('open');
          div.appendChild(label);
          div.appendChild(children);
        }
        div.appendChild(label);
      });
      container.appendChild(div);
    }
    buildNode(filesObj);
  }

  // Clustering logic same as yours...
  function clusterGloballyAllVersions(data) {
    const flat = [];
    Object.keys(data).forEach(f => {
      data[f].versions.forEach(v => {
        const t = Date.parse(v.timestamp);
        flat.push({ folder: f, versionObj: v, timestampMs: t });
      });
    });
    flat.sort((a,b) => a.timestampMs - b.timestampMs);
    const clusters = [];
    let cur = null;
    flat.forEach(it => {
      if (!cur || it.timestampMs - cur.startMs > 3000) {
        cur = { id: clusters.length + 1, startMs: it.timestampMs, items: [it] };
        clusters.push(cur);
      } else {
        cur.items.push(it);
      }
    });
    clusters.forEach((c, i) => {
      c.color = SAVE_ALL_COLORS[i % SAVE_ALL_COLORS.length];
      c.border = darken(c.color, 40);
      c.items.forEach(x => x.versionObj._globalCluster = { id: c.id, color: c.color, border: c.border });
    });
    return clusters;
  }

  function renderDashboard(data) {
    const container = document.getElementById('dashboard');
    container.innerHTML = '';
    const filtered = selectedGroup === 'all' ? data : 
      Object.keys(data).reduce((acc, f) => {
        const vers = data[f].versions.filter(v => v._globalCluster?.id == selectedGroup);
        if (vers.length) acc[f] = { versions: vers };
        return acc;
      }, {});

    Object.keys(filtered).forEach(folderName => {
      const folderDiv = document.createElement('div');
      folderDiv.className = 'folder';
      folderDiv.innerHTML = `<h2>${folderName}</h2>`;
      
      filtered[folderName].versions.forEach((version, idx) => {
        const cluster = version._globalCluster || {};
        const versionKey = `${folderName}-v${version.version}`;
        const header = document.createElement('div');
        header.className = 'version-header';
        header.style.background = cluster.color || '#f9f9f9';
        header.style.borderLeft = `5px solid ${cluster.border || '#ccc'}`;
        header.innerHTML = `
          <span>Version ${version.version} — ${toIndianTimeStr(version.timestamp)}</span>
          ${cluster.id ? `<span class="badge" style="background:${cluster.border};color:white;">GROUP #${cluster.id}</span>` : ''}
        `;
        const content = document.createElement('div');
        content.className = 'tree-container';
        renderFileTree(content, version.files, cluster, versionKey);

        const runBtn = document.createElement('button');
        runBtn.className = 'run-btn';
        runBtn.innerHTML = '<i class="fas fa-play"></i> Run This Version';
        runBtn.style.margin = '10px 16px';
        runBtn.onclick = () => runVersion(version.files);

        header.onclick = () => content.classList.toggle('open');
        const versionDiv = document.createElement('div');
        versionDiv.className = 'version';
        versionDiv.appendChild(header);
        versionDiv.appendChild(content);
        versionDiv.appendChild(runBtn);
        folderDiv.appendChild(versionDiv);
      });
      container.appendChild(folderDiv);
    });
  }

  function runVersion(files) {
    let html = '', css = '', js = '';
    function traverse(obj) {
      Object.keys(obj).forEach(k => {
        const v = obj[k];
        if (typeof v === 'object') traverse(v);
        else if (k.endsWith('.html')) html += v;
        else if (k.endsWith('.css')) css += `<style>${v}</style>`;
        else if (k.endsWith('.js')) js += `<script>${v}<\/script>`;
      });
    }
    traverse(files);
    const output = `${html}${css}${js}`;
    const iframe = document.getElementById('preview');
    iframe.srcdoc = output || '<h1 style="color:#666;text-align:center;margin-top:100px;">No runnable files found</h1>';
  }

  function renderGroupBar() {
    const bar = document.getElementById('groupBar');
    bar.innerHTML = '';
    ['all', ...currentClusters.map(c => c.id)].forEach(g => {
      const btn = document.createElement('button');
      btn.className = 'group-btn';
      btn.textContent = g === 'all' ? 'All' : `Group ${g}`;
      if (g !== 'all') {
        btn.style.background = currentClusters.find(c=>c.id==g).color;
        btn.style.color = 'black';
      } else {
        btn.classList.add('all');
      }
      if (g == selectedGroup) btn.classList.add('active');
      btn.onclick = () => { selectedGroup = g; renderDashboard(currentData); renderGroupBar(); };
      bar.appendChild(btn);
    });
  }

  async function loadDashboard(sample = false) {
    let data = sample ? getSampleData() : await (await fetch('/fetchDashboard').catch(()=>null))?.json();
    if (!data) data = getSampleData();
    currentClusters = clusterGloballyAllVersions(data);
    currentData = data;
    selectedGroup = 'all';
    renderGroupBar();
    renderDashboard(data);
  }

  function getSampleData() {
    return { /* same as yours */ };
  }

  document.getElementById('reloadBtn').onclick = () => loadDashboard(false);
  document.getElementById('sampleBtn').onclick = () => loadDashboard(true);
  document.getElementById('runAllBtn').onclick = () => alert('Choose a version first!');

  loadDashboard(true); // auto load sample
</script>
</body>
</html>
